name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

      - name: Run tests with race detection
        run: go test -short -race -coverprofile=coverage.out ./...

      - name: Check coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below the minimum threshold of 60%"
            exit 1
          fi
          echo "Coverage check passed: ${COVERAGE}% >= 60%"

      - name: Run endpoint tests specifically
        run: go test -race -v -run "TestMetrics.*|TestHealth.*|TestReady.*|TestStats.*|TestEndpoints.*" ./internal/metrics/...

  goreleaser:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run GoReleaser (with Docker)
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser (without Docker)
        if: ${{ secrets.DOCKERHUB_USERNAME == '' || secrets.DOCKERHUB_TOKEN == '' }}
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --skip=docker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify-release:
    runs-on: ubuntu-latest
    needs: goreleaser
    steps:
      - name: Verify release exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Verifying release for tag: $TAG"

          # Wait for release to be available
          for i in {1..10}; do
            if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
              echo "Release $TAG found!"
              gh release view "$TAG" --repo ${{ github.repository }}
              exit 0
            fi
            echo "Attempt $i: Release not yet available, waiting..."
            sleep 10
          done

          echo "::error::Release $TAG not found after 100 seconds"
          exit 1

      - name: List release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Assets for release $TAG:"
          gh release view "$TAG" --repo ${{ github.repository }} --json assets -q '.assets[].name' | sort

          # Count assets
          ASSET_COUNT=$(gh release view "$TAG" --repo ${{ github.repository }} --json assets -q '.assets | length')
          echo "Total assets: $ASSET_COUNT"

          # We expect at least 35 binary archives + checksums
          if [ "$ASSET_COUNT" -lt 30 ]; then
            echo "::warning::Expected at least 30 assets, got $ASSET_COUNT"
          fi
